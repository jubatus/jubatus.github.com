

<!DOCTYPE html>
<!--[if IE 8]><html class="no-js lt-ie9" lang="en" > <![endif]-->
<!--[if gt IE 8]><!--> <html class="no-js" lang="en" > <!--<![endif]-->
<head>
  <meta charset="utf-8">
  
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  
  <title>Anomaly チュートリアル (Java) &mdash; Jubatus</title>
  

  
  
    <link rel="shortcut icon" href="../_static/favicon.ico"/>
  

  

  
  
    

  

  
  
    <link rel="stylesheet" href="../_static/css/theme.css" type="text/css" />
  

  
    <link rel="stylesheet" href="../_static/custom.css" type="text/css" />
  

  
    <link rel="top" title="Jubatus" href="../index.html"/>
        <link rel="up" title="Anomaly チュートリアル" href="anomaly.html"/>
        <link rel="next" title="Regression チュートリアル" href="regression.html"/>
        <link rel="prev" title="Anomaly チュートリアル (Ruby)" href="anomaly_ruby.html"/> 

  
  <script src="../_static/js/modernizr.min.js"></script>

</head>

<body class="wy-body-for-nav" role="document">

  <div class="wy-grid-for-nav">

    
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search">
          

          
            <a href="../index.html" class="icon icon-home"> Jubatus
          

          
            
            <img src="../_static/title.png" class="logo" />
          
          </a>

          
            
            
          

          
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="../search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>

          
        </div>

        <div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="main navigation">
          
            
            
                <ul class="current">
<li class="toctree-l1"><a class="reference internal" href="../overview/index.html">Jubatus Overview</a></li>
<li class="toctree-l1"><a class="reference internal" href="../quickstart.html">クイックスタート</a></li>
<li class="toctree-l1 current"><a class="reference internal" href="index.html">チュートリアル</a><ul class="current">
<li class="toctree-l2"><a class="reference internal" href="tutorial.html">Basic チュートリアル</a></li>
<li class="toctree-l2"><a class="reference internal" href="classifier.html">Classifier チュートリアル</a></li>
<li class="toctree-l2"><a class="reference internal" href="recommender.html">Recommender チュートリアル</a></li>
<li class="toctree-l2 current"><a class="reference internal" href="anomaly.html">Anomaly チュートリアル</a><ul class="current">
<li class="toctree-l3"><a class="reference internal" href="anomaly.html#id1">サンプルプログラムの概要</a></li>
<li class="toctree-l3"><a class="reference internal" href="anomaly.html#id2">処理の流れ</a></li>
<li class="toctree-l3 current"><a class="reference internal" href="anomaly.html#id3">サンプルプログラム</a><ul class="current">
<li class="toctree-l4"><a class="reference internal" href="anomaly_python.html">Anomaly チュートリアル (Python)</a></li>
<li class="toctree-l4"><a class="reference internal" href="anomaly_ruby.html">Anomaly チュートリアル (Ruby)</a></li>
<li class="toctree-l4 current"><a class="current reference internal" href="#">Anomaly チュートリアル (Java)</a></li>
</ul>
</li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="regression.html">Regression チュートリアル</a></li>
<li class="toctree-l2"><a class="reference internal" href="graph.html">Graph チュートリアル</a></li>
<li class="toctree-l2"><a class="reference internal" href="stat.html">Stat チュートリアル</a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="../tutorial_distributed.html">分散モード</a></li>
<li class="toctree-l1"><a class="reference internal" href="../method.html">アルゴリズム</a></li>
<li class="toctree-l1"><a class="reference internal" href="../fv_convert.html">データ変換</a></li>
<li class="toctree-l1"><a class="reference internal" href="../commands/index.html">Commands</a></li>
<li class="toctree-l1"><a class="reference internal" href="../api/index.html">Client API</a></li>
<li class="toctree-l1"><a class="reference internal" href="../tips_faqs/index.html">Tips and FAQs</a></li>
<li class="toctree-l1"><a class="reference internal" href="../developers/index.html">開発者ガイド</a></li>
<li class="toctree-l1"><a class="reference internal" href="../jubaql/index.html">JubaQL</a></li>
<li class="toctree-l1"><a class="reference internal" href="../about/index.html">プロジェクトについて</a></li>
</ul>

            
          
        </div>
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap">

      
      <nav class="wy-nav-top" role="navigation" aria-label="top navigation">
        <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
        <a href="../index.html">Jubatus</a>
      </nav>


      
      <div class="wy-nav-content">
        <div class="rst-content">
          

 



<div role="navigation" aria-label="breadcrumbs navigation">
  <ul class="wy-breadcrumbs">
    <li><a href="../index.html">Docs</a> &raquo;</li>
      
          <li><a href="index.html">チュートリアル</a> &raquo;</li>
      
          <li><a href="anomaly.html">Anomaly チュートリアル</a> &raquo;</li>
      
    <li>Anomaly チュートリアル (Java)</li>
      <li class="wy-breadcrumbs-aside">
        
          
        
      </li>
  </ul>
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
            
  <div class="section" id="anomaly-java">
<h1>Anomaly チュートリアル (Java)<a class="headerlink" href="#anomaly-java" title="このヘッドラインへのパーマリンク">¶</a></h1>
<p>ここではJava版のAnomalyサンプルプログラムの解説をします。</p>
<div class="section" id="id1">
<h2>ソースコード<a class="headerlink" href="#id1" title="このヘッドラインへのパーマリンク">¶</a></h2>
<p>このサンプルプログラムでは、学習の設定をするconfig.jsonと外れ値検知を行うlof.javaを利用します。以下にソースコードを記載します。</p>
<p><strong>config.json</strong></p>
<div class="highlight-python"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre> 1
 2
 3
 4
 5
 6
 7
 8
 9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26</pre></div></td><td class="code"><div class="highlight"><pre><span></span><span class="p">{</span>
 <span class="s2">&quot;method&quot;</span> <span class="p">:</span> <span class="s2">&quot;lof&quot;</span><span class="p">,</span>
 <span class="s2">&quot;parameter&quot;</span> <span class="p">:</span> <span class="p">{</span>
  <span class="s2">&quot;nearest_neighbor_num&quot;</span> <span class="p">:</span> <span class="mi">10</span><span class="p">,</span>
  <span class="s2">&quot;reverse_nearest_neighbor_num&quot;</span> <span class="p">:</span> <span class="mi">30</span><span class="p">,</span>
  <span class="s2">&quot;method&quot;</span> <span class="p">:</span> <span class="s2">&quot;euclid_lsh&quot;</span><span class="p">,</span>
  <span class="s2">&quot;parameter&quot;</span> <span class="p">:</span> <span class="p">{</span>
   <span class="s2">&quot;hash_num&quot;</span> <span class="p">:</span> <span class="mi">8</span><span class="p">,</span>
   <span class="s2">&quot;table_num&quot;</span> <span class="p">:</span> <span class="mi">16</span><span class="p">,</span>
   <span class="s2">&quot;probe_num&quot;</span> <span class="p">:</span> <span class="mi">64</span><span class="p">,</span>
   <span class="s2">&quot;bin_width&quot;</span> <span class="p">:</span> <span class="mi">10</span><span class="p">,</span>
   <span class="s2">&quot;seed&quot;</span> <span class="p">:</span> <span class="mi">1234</span>
  <span class="p">}</span>
 <span class="p">},</span>

 <span class="s2">&quot;converter&quot;</span> <span class="p">:</span> <span class="p">{</span>
  <span class="s2">&quot;string_filter_types&quot;</span><span class="p">:</span> <span class="p">{},</span>
  <span class="s2">&quot;string_filter_rules&quot;</span><span class="p">:</span> <span class="p">[],</span>
  <span class="s2">&quot;num_filter_types&quot;</span><span class="p">:</span> <span class="p">{},</span>
  <span class="s2">&quot;num_filter_rules&quot;</span><span class="p">:</span> <span class="p">[],</span>
  <span class="s2">&quot;string_types&quot;</span><span class="p">:</span> <span class="p">{},</span>
  <span class="s2">&quot;string_rules&quot;</span><span class="p">:</span> <span class="p">[{</span><span class="s2">&quot;key&quot;</span><span class="p">:</span><span class="s2">&quot;*&quot;</span><span class="p">,</span> <span class="s2">&quot;type&quot;</span><span class="p">:</span><span class="s2">&quot;str&quot;</span><span class="p">,</span> <span class="s2">&quot;global_weight&quot;</span> <span class="p">:</span> <span class="s2">&quot;bin&quot;</span><span class="p">,</span> <span class="s2">&quot;sample_weight&quot;</span> <span class="p">:</span> <span class="s2">&quot;bin&quot;</span><span class="p">}],</span>
  <span class="s2">&quot;num_types&quot;</span><span class="p">:</span> <span class="p">{},</span>
  <span class="s2">&quot;num_rules&quot;</span><span class="p">:</span> <span class="p">[{</span><span class="s2">&quot;key&quot;</span> <span class="p">:</span> <span class="s2">&quot;*&quot;</span><span class="p">,</span> <span class="s2">&quot;type&quot;</span> <span class="p">:</span> <span class="s2">&quot;num&quot;</span><span class="p">}]</span>
 <span class="p">}</span>
<span class="p">}</span>
</pre></div>
</td></tr></table></div>
<p><strong>anomaly.java</strong></p>
<div class="highlight-java"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre>  1
  2
  3
  4
  5
  6
  7
  8
  9
 10
 11
 12
 13
 14
 15
 16
 17
 18
 19
 20
 21
 22
 23
 24
 25
 26
 27
 28
 29
 30
 31
 32
 33
 34
 35
 36
 37
 38
 39
 40
 41
 42
 43
 44
 45
 46
 47
 48
 49
 50
 51
 52
 53
 54
 55
 56
 57
 58
 59
 60
 61
 62
 63
 64
 65
 66
 67
 68
 69
 70
 71
 72
 73
 74
 75
 76
 77
 78
 79
 80
 81
 82
 83
 84
 85
 86
 87
 88
 89
 90
 91
 92
 93
 94
 95
 96
 97
 98
 99
100
101
102
103
104
105
106
107
108
109
110
111
112
113
114
115
116
117
118
119
120
121
122
123
124
125
126
127
128
129
130
131
132
133
134
135
136
137
138
139
140
141
142
143
144
145
146
147
148
149
150
151
152
153
154
155
156
157
158
159
160
161
162
163
164
165
166
167
168
169
170
171
172
173
174
175
176
177
178
179
180
181
182
183
184
185
186
187
188
189
190</pre></div></td><td class="code"><div class="highlight"><pre><span></span>  <span class="kn">package</span> <span class="nn">us.jubat.example.kddcup</span><span class="o">;</span>

  <span class="kn">import</span> <span class="nn">us.jubat.anomaly.AnomalyClient</span><span class="o">;</span>
  <span class="kn">import</span> <span class="nn">us.jubat.anomaly.IdWithScore</span><span class="o">;</span>
  <span class="kn">import</span> <span class="nn">us.jubat.common.Datum</span><span class="o">;</span>

  <span class="kn">import</span> <span class="nn">java.io.*</span><span class="o">;</span>
  <span class="kn">import</span> <span class="nn">java.util.ArrayList</span><span class="o">;</span>
  <span class="kn">import</span> <span class="nn">java.util.Arrays</span><span class="o">;</span>
  <span class="kn">import</span> <span class="nn">java.util.List</span><span class="o">;</span>

  <span class="kd">public</span> <span class="kd">class</span> <span class="nc">Lof</span> <span class="o">{</span>
      <span class="kd">public</span> <span class="kd">static</span> <span class="kd">final</span> <span class="n">String</span> <span class="n">HOST</span> <span class="o">=</span> <span class="s">&quot;127.0.0.1&quot;</span><span class="o">;</span>
      <span class="kd">public</span> <span class="kd">static</span> <span class="kd">final</span> <span class="kt">int</span> <span class="n">PORT</span> <span class="o">=</span> <span class="mi">9199</span><span class="o">;</span>
      <span class="kd">public</span> <span class="kd">static</span> <span class="kd">final</span> <span class="n">String</span> <span class="n">NAME</span> <span class="o">=</span> <span class="s">&quot;anom_kddcup&quot;</span><span class="o">;</span>
      <span class="kd">public</span> <span class="kd">static</span> <span class="kd">final</span> <span class="n">String</span> <span class="n">FILE_PATH</span> <span class="o">=</span> <span class="s">&quot;../&quot;</span><span class="o">;</span>
      <span class="kd">public</span> <span class="kd">static</span> <span class="kd">final</span> <span class="n">String</span> <span class="n">TEXT_NAME</span> <span class="o">=</span> <span class="s">&quot;kddcup.data_10_percent.txt&quot;</span><span class="o">;</span>

      <span class="c1">// Define TEXT column names</span>
      <span class="kd">public</span> <span class="kd">static</span> <span class="n">String</span><span class="o">[]</span> <span class="n">TEXT_COLUMN</span> <span class="o">=</span> <span class="o">{</span>
              <span class="s">&quot;duration&quot;</span><span class="o">,</span>
              <span class="s">&quot;protocol_type&quot;</span><span class="o">,</span>
              <span class="s">&quot;service&quot;</span><span class="o">,</span>
              <span class="s">&quot;flag&quot;</span><span class="o">,</span>
              <span class="s">&quot;src_bytes&quot;</span><span class="o">,</span>
              <span class="s">&quot;dst_bytes&quot;</span><span class="o">,</span>
              <span class="s">&quot;land&quot;</span><span class="o">,</span>
              <span class="s">&quot;wrong_fragment&quot;</span><span class="o">,</span>
              <span class="s">&quot;urgent&quot;</span><span class="o">,</span>
              <span class="s">&quot;hot&quot;</span><span class="o">,</span>
              <span class="s">&quot;num_failed_logins&quot;</span><span class="o">,</span>
              <span class="s">&quot;logged_in&quot;</span><span class="o">,</span>
              <span class="s">&quot;num_compromised&quot;</span><span class="o">,</span>
              <span class="s">&quot;root_shell&quot;</span><span class="o">,</span>
              <span class="s">&quot;su_attempted&quot;</span><span class="o">,</span>
              <span class="s">&quot;num_root&quot;</span><span class="o">,</span>
              <span class="s">&quot;num_file_creations&quot;</span><span class="o">,</span>
              <span class="s">&quot;num_shells&quot;</span><span class="o">,</span>
              <span class="s">&quot;num_access_files&quot;</span><span class="o">,</span>
              <span class="s">&quot;num_outbound_cmds&quot;</span><span class="o">,</span>
              <span class="s">&quot;is_host_login&quot;</span><span class="o">,</span>
              <span class="s">&quot;is_guest_login&quot;</span><span class="o">,</span>
              <span class="s">&quot;count&quot;</span><span class="o">,</span>
              <span class="s">&quot;srv_count&quot;</span><span class="o">,</span>
              <span class="s">&quot;serror_rate&quot;</span><span class="o">,</span>
              <span class="s">&quot;srv_serror_rate&quot;</span><span class="o">,</span>
              <span class="s">&quot;rerror_rate&quot;</span><span class="o">,</span>
              <span class="s">&quot;srv_rerror_rate&quot;</span><span class="o">,</span>
              <span class="s">&quot;same_srv_rate&quot;</span><span class="o">,</span>
              <span class="s">&quot;diff_srv_rate&quot;</span><span class="o">,</span>
              <span class="s">&quot;srv_diff_host_rate&quot;</span><span class="o">,</span>
              <span class="s">&quot;dst_host_count&quot;</span><span class="o">,</span>
              <span class="s">&quot;dst_host_srv_count&quot;</span><span class="o">,</span>
              <span class="s">&quot;dst_host_same_srv_rate&quot;</span><span class="o">,</span>
              <span class="s">&quot;dst_host_diff_srv_rate&quot;</span><span class="o">,</span>
              <span class="s">&quot;dst_host_same_src_port_rate&quot;</span><span class="o">,</span>
              <span class="s">&quot;dst_host_srv_diff_host_rate&quot;</span><span class="o">,</span>
              <span class="s">&quot;dst_host_serror_rate&quot;</span><span class="o">,</span>
              <span class="s">&quot;dst_host_srv_serror_rate&quot;</span><span class="o">,</span>
              <span class="s">&quot;dst_host_rerror_rate&quot;</span><span class="o">,</span>
              <span class="s">&quot;dst_host_srv_rerror_rate&quot;</span><span class="o">,</span>
              <span class="s">&quot;label&quot;</span>
      <span class="o">};</span>

      <span class="c1">// Define STRING column names</span>
      <span class="kd">public</span> <span class="kd">static</span> <span class="n">String</span><span class="o">[]</span> <span class="n">STRING_COLUMN</span> <span class="o">=</span> <span class="o">{</span>
              <span class="s">&quot;protocol_type&quot;</span><span class="o">,</span>
              <span class="s">&quot;service&quot;</span><span class="o">,</span>
              <span class="s">&quot;flag&quot;</span><span class="o">,</span>
              <span class="s">&quot;land&quot;</span><span class="o">,</span>
              <span class="s">&quot;logged_in&quot;</span><span class="o">,</span>
              <span class="s">&quot;is_host_login&quot;</span><span class="o">,</span>
              <span class="s">&quot;is_guest_login&quot;</span>
      <span class="o">};</span>

      <span class="c1">// Define DOUBLE column names</span>
      <span class="kd">public</span> <span class="kd">static</span> <span class="n">String</span><span class="o">[]</span> <span class="n">DOUBLE_COLUMN</span> <span class="o">=</span> <span class="o">{</span>
              <span class="s">&quot;duration&quot;</span><span class="o">,</span>
              <span class="s">&quot;src_bytes&quot;</span><span class="o">,</span>
              <span class="s">&quot;dst_bytes&quot;</span><span class="o">,</span>
              <span class="s">&quot;wrong_fragment&quot;</span><span class="o">,</span>
              <span class="s">&quot;urgent&quot;</span><span class="o">,</span>
              <span class="s">&quot;hot&quot;</span><span class="o">,</span>
              <span class="s">&quot;num_failed_logins&quot;</span><span class="o">,</span>
              <span class="s">&quot;num_compromised&quot;</span><span class="o">,</span>
              <span class="s">&quot;root_shell&quot;</span><span class="o">,</span>
              <span class="s">&quot;su_attempted&quot;</span><span class="o">,</span>
              <span class="s">&quot;num_root&quot;</span><span class="o">,</span>
              <span class="s">&quot;num_file_creations&quot;</span><span class="o">,</span>
              <span class="s">&quot;num_shells&quot;</span><span class="o">,</span>
              <span class="s">&quot;num_access_files&quot;</span><span class="o">,</span>
              <span class="s">&quot;num_outbound_cmds&quot;</span><span class="o">,</span>
              <span class="s">&quot;count&quot;</span><span class="o">,</span>
              <span class="s">&quot;srv_count&quot;</span><span class="o">,</span>
              <span class="s">&quot;serror_rate&quot;</span><span class="o">,</span>
              <span class="s">&quot;srv_serror_rate&quot;</span><span class="o">,</span>
              <span class="s">&quot;rerror_rate&quot;</span><span class="o">,</span>
              <span class="s">&quot;srv_rerror_rate&quot;</span><span class="o">,</span>
              <span class="s">&quot;same_srv_rate&quot;</span><span class="o">,</span>
              <span class="s">&quot;diff_srv_rate&quot;</span><span class="o">,</span>
              <span class="s">&quot;srv_diff_host_rate&quot;</span><span class="o">,</span>
              <span class="s">&quot;dst_host_count&quot;</span><span class="o">,</span>
              <span class="s">&quot;dst_host_srv_count&quot;</span><span class="o">,</span>
              <span class="s">&quot;dst_host_same_srv_rate&quot;</span><span class="o">,</span>
              <span class="s">&quot;dst_host_same_src_port_rate&quot;</span><span class="o">,</span>
              <span class="s">&quot;dst_host_diff_srv_rate&quot;</span><span class="o">,</span>
              <span class="s">&quot;dst_host_srv_diff_host_rate&quot;</span><span class="o">,</span>
              <span class="s">&quot;dst_host_serror_rate&quot;</span><span class="o">,</span>
              <span class="s">&quot;dst_host_srv_serror_rate&quot;</span><span class="o">,</span>
              <span class="s">&quot;dst_host_rerror_rate&quot;</span><span class="o">,</span>
              <span class="s">&quot;dst_host_srv_rerror_rate&quot;</span>
      <span class="o">};</span>

      <span class="kd">public</span> <span class="kt">void</span> <span class="nf">execute</span><span class="o">()</span> <span class="kd">throws</span> <span class="n">Exception</span> <span class="o">{</span>
          <span class="c1">// 1. Connect to Jubatus Server</span>
          <span class="n">AnomalyClient</span> <span class="n">client</span> <span class="o">=</span> <span class="k">new</span> <span class="n">AnomalyClient</span><span class="o">(</span><span class="n">HOST</span><span class="o">,</span> <span class="n">PORT</span> <span class="o">,</span> <span class="n">NAME</span><span class="o">,</span> <span class="mi">5</span><span class="o">);</span>

          <span class="c1">// 2. Prepare training dataset</span>
          <span class="n">Datum</span> <span class="n">datum</span> <span class="o">=</span> <span class="kc">null</span><span class="o">;</span>
          <span class="n">IdWithScore</span> <span class="n">result</span> <span class="o">=</span> <span class="kc">null</span><span class="o">;</span>

          <span class="k">try</span> <span class="o">{</span>
              <span class="n">BufferedReader</span> <span class="n">br</span> <span class="o">=</span> <span class="k">new</span> <span class="n">BufferedReader</span><span class="o">(</span><span class="k">new</span> <span class="n">FileReader</span><span class="o">(</span><span class="k">new</span> <span class="n">File</span><span class="o">(</span><span class="n">FILE_PATH</span> <span class="o">,</span> <span class="n">TEXT_NAME</span><span class="o">)));</span>

              <span class="n">List</span><span class="o">&lt;</span><span class="n">String</span><span class="o">&gt;</span> <span class="n">strList</span> <span class="o">=</span> <span class="k">new</span> <span class="n">ArrayList</span><span class="o">&lt;</span><span class="n">String</span><span class="o">&gt;();</span>
              <span class="n">List</span><span class="o">&lt;</span><span class="n">String</span><span class="o">&gt;</span> <span class="n">doubleList</span> <span class="o">=</span> <span class="k">new</span> <span class="n">ArrayList</span><span class="o">&lt;</span><span class="n">String</span><span class="o">&gt;();</span>

              <span class="n">String</span> <span class="n">line</span> <span class="o">=</span> <span class="s">&quot;&quot;</span><span class="o">;</span>

              <span class="k">while</span> <span class="o">((</span><span class="n">line</span> <span class="o">=</span> <span class="n">br</span><span class="o">.</span><span class="na">readLine</span><span class="o">())</span> <span class="o">!=</span> <span class="kc">null</span><span class="o">)</span> <span class="o">{</span>
                  <span class="n">strList</span><span class="o">.</span><span class="na">clear</span><span class="o">();</span>
                  <span class="n">doubleList</span><span class="o">.</span><span class="na">clear</span><span class="o">();</span>

                  <span class="n">String</span><span class="o">[]</span> <span class="n">strAry</span> <span class="o">=</span> <span class="n">line</span><span class="o">.</span><span class="na">split</span><span class="o">(</span><span class="s">&quot;,&quot;</span><span class="o">);</span>

                  <span class="c1">// make STRING list and DOUBLE list</span>
                  <span class="k">for</span> <span class="o">(</span><span class="kt">int</span> <span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="o">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">strAry</span><span class="o">.</span><span class="na">length</span><span class="o">;</span> <span class="n">i</span><span class="o">++)</span> <span class="o">{</span>
                      <span class="k">if</span> <span class="o">(</span><span class="n">Arrays</span><span class="o">.</span><span class="na">toString</span><span class="o">(</span><span class="n">STRING_COLUMN</span><span class="o">).</span><span class="na">contains</span><span class="o">(</span><span class="n">TEXT_COLUMN</span><span class="o">[</span><span class="n">i</span><span class="o">]))</span> <span class="o">{</span>
                          <span class="n">strList</span><span class="o">.</span><span class="na">add</span><span class="o">(</span><span class="n">strAry</span><span class="o">[</span><span class="n">i</span><span class="o">]);</span>
                      <span class="o">}</span> <span class="k">else</span> <span class="k">if</span> <span class="o">(</span><span class="n">Arrays</span><span class="o">.</span><span class="na">toString</span><span class="o">(</span><span class="n">DOUBLE_COLUMN</span><span class="o">).</span><span class="na">contains</span><span class="o">(</span><span class="n">TEXT_COLUMN</span><span class="o">[</span><span class="n">i</span><span class="o">]))</span> <span class="o">{</span>
                          <span class="n">doubleList</span><span class="o">.</span><span class="na">add</span><span class="o">(</span><span class="n">strAry</span><span class="o">[</span><span class="n">i</span><span class="o">]);</span>
                      <span class="o">}</span>
                  <span class="o">}</span>
                  <span class="c1">// make Datum</span>
                  <span class="n">datum</span> <span class="o">=</span> <span class="n">makeDatum</span><span class="o">(</span><span class="n">strList</span><span class="o">,</span> <span class="n">doubleList</span><span class="o">);</span>

                  <span class="c1">// 3. Update the training model</span>
                  <span class="n">result</span> <span class="o">=</span> <span class="n">client</span><span class="o">.</span><span class="na">add</span><span class="o">(</span><span class="n">datum</span><span class="o">);</span>

                  <span class="c1">// 4. Output results</span>
                  <span class="k">if</span> <span class="o">(!(</span><span class="n">Float</span><span class="o">.</span><span class="na">isInfinite</span><span class="o">(</span><span class="n">result</span><span class="o">.</span><span class="na">score</span><span class="o">))</span> <span class="o">&amp;&amp;</span> <span class="n">result</span><span class="o">.</span><span class="na">score</span> <span class="o">!=</span> <span class="mf">1.0</span><span class="o">)</span> <span class="o">{</span>
                      <span class="n">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">print</span><span class="o">(</span><span class="s">&quot;(&#39;&quot;</span> <span class="o">+</span> <span class="n">result</span><span class="o">.</span><span class="na">id</span> <span class="o">+</span> <span class="s">&quot;&#39;, &quot;</span> <span class="o">+</span> <span class="n">result</span><span class="o">.</span><span class="na">score</span> <span class="o">+</span> <span class="s">&quot;) &quot;</span> <span class="o">+</span> <span class="n">strAry</span><span class="o">[</span><span class="n">strAry</span><span class="o">.</span><span class="na">length</span> <span class="o">-</span> <span class="mi">1</span><span class="o">]</span> <span class="o">+</span> <span class="s">&quot;\n&quot;</span><span class="o">);</span>
                  <span class="o">}</span>
              <span class="o">}</span>
              <span class="n">br</span><span class="o">.</span><span class="na">close</span><span class="o">();</span>

          <span class="o">}</span> <span class="k">catch</span> <span class="o">(</span><span class="n">FileNotFoundException</span> <span class="n">e</span><span class="o">)</span> <span class="o">{</span>
              <span class="n">e</span><span class="o">.</span><span class="na">printStackTrace</span><span class="o">();</span>
          <span class="o">}</span> <span class="k">catch</span> <span class="o">(</span><span class="n">IOException</span> <span class="n">e</span><span class="o">)</span> <span class="o">{</span>
              <span class="n">e</span><span class="o">.</span><span class="na">printStackTrace</span><span class="o">();</span>
          <span class="o">}</span>
          <span class="k">return</span><span class="o">;</span>
      <span class="o">}</span>

      <span class="kd">private</span> <span class="n">Datum</span> <span class="nf">makeDatum</span><span class="o">(</span><span class="n">List</span><span class="o">&lt;</span><span class="n">String</span><span class="o">&gt;</span> <span class="n">strList</span><span class="o">,</span> <span class="n">List</span><span class="o">&lt;</span><span class="n">String</span><span class="o">&gt;</span> <span class="n">doubleList</span><span class="o">)</span> <span class="o">{</span>

          <span class="n">Datum</span> <span class="n">datum</span> <span class="o">=</span> <span class="k">new</span> <span class="n">Datum</span><span class="o">();</span>

          <span class="k">for</span> <span class="o">(</span><span class="kt">int</span> <span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="o">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">strList</span><span class="o">.</span><span class="na">size</span><span class="o">();</span> <span class="n">i</span><span class="o">++)</span> <span class="o">{</span>
              <span class="n">datum</span><span class="o">.</span><span class="na">addString</span><span class="o">(</span><span class="n">STRING_COLUMN</span><span class="o">[</span><span class="n">i</span><span class="o">],</span><span class="n">strList</span><span class="o">.</span><span class="na">get</span><span class="o">(</span><span class="n">i</span><span class="o">));</span>
          <span class="o">}</span>

          <span class="k">try</span> <span class="o">{</span>
              <span class="k">for</span> <span class="o">(</span><span class="kt">int</span> <span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="o">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">doubleList</span><span class="o">.</span><span class="na">size</span><span class="o">();</span> <span class="n">i</span><span class="o">++)</span> <span class="o">{</span>
                  <span class="n">datum</span><span class="o">.</span><span class="na">addNumber</span><span class="o">(</span><span class="n">DOUBLE_COLUMN</span><span class="o">[</span><span class="n">i</span><span class="o">],</span><span class="n">Double</span><span class="o">.</span><span class="na">parseDouble</span><span class="o">(</span><span class="n">doubleList</span><span class="o">.</span><span class="na">get</span><span class="o">(</span><span class="n">i</span><span class="o">)));</span>
              <span class="o">}</span>
          <span class="o">}</span> <span class="k">catch</span> <span class="o">(</span><span class="n">NumberFormatException</span> <span class="n">e</span><span class="o">)</span> <span class="o">{</span>
              <span class="n">e</span><span class="o">.</span><span class="na">printStackTrace</span><span class="o">();</span>
              <span class="k">return</span> <span class="kc">null</span><span class="o">;</span>
          <span class="o">}</span>

          <span class="k">return</span> <span class="n">datum</span><span class="o">;</span>
      <span class="o">}</span>

      <span class="kd">public</span> <span class="kd">static</span> <span class="kt">void</span> <span class="nf">main</span><span class="o">(</span><span class="n">String</span><span class="o">[]</span> <span class="n">args</span><span class="o">)</span> <span class="kd">throws</span> <span class="n">Exception</span> <span class="o">{</span>

          <span class="k">new</span> <span class="n">Lof</span><span class="o">().</span><span class="na">execute</span><span class="o">();</span>
          <span class="n">System</span><span class="o">.</span><span class="na">exit</span><span class="o">(</span><span class="mi">0</span><span class="o">);</span>
      <span class="o">}</span>
  <span class="o">}</span>
</pre></div>
</td></tr></table></div>
</div>
<div class="section" id="id2">
<h2>解説<a class="headerlink" href="#id2" title="このヘッドラインへのパーマリンク">¶</a></h2>
<p><strong>config.json</strong></p>
<p>設定は単体のJSONで与えられます。JSONの各フィールドは以下のとおりです。</p>
<ul class="simple">
<li>method</li>
</ul>
<blockquote>
<div>異常検知に使用するアルコリズムを指定します。
Anomalyで指定できるのは、Recommenderベースの&#8221;lof&#8221;およびNearest Neighborベースの&#8221;light lof&#8221;です。
今回は&#8221;lof&#8221;（Local Outlier Factor）を指定します。</div></blockquote>
<ul class="simple">
<li>parameter</li>
</ul>
<dl class="docutils">
<dt>　methodで設定した異常検知アルゴリズムのパラメータを設定します。</dt>
<dd>今回は&#8221;lof&#8221;を利用するため、<a class="reference external" href="http://jubat.us/ja/api_recommender.html">Recommender API</a> に従ってパラメータを設定します。</dd>
</dl>
<ul class="simple">
<li>converter</li>
</ul>
<blockquote>
<div><p>特徴変換の設定を指定します。
ここでは、&#8221;num_rules&#8221;と&#8221;string_rules&#8221;を設定しています。</p>
<p>&#8220;num_rules&#8221;は数値特徴の抽出規則を指定します。
&#8220;key&#8221;は&#8221;*&#8221;つまり、すべての&#8221;key&#8221;に対して、&#8221;type&#8221;は&#8221;num&#8221;なので、指定された数値をそのまま重みに利用する設定です。
具体的には、valueが&#8221;2&#8221;であれば&#8221;2&#8221;を、&#8221;6&#8221;であれば&#8221;6&#8221;を重みとします。</p>
<p>&#8220;string_rules&#8221;は文字列特徴の抽出規則を指定します。
&#8220;key&#8221;は&#8221;*&#8221;、&#8221;type&#8221;は&#8221;str&#8221;、&#8221;sample_weight&#8221;は&#8221;bin&#8221;、&#8221;global_weight&#8221;は&#8221;bin&#8221;としています。
これは、すべての文字列に対して、指定された文字列をそのまま特徴として利用し、各key-value毎の重みと今までの通算データから算出される、大域的な重みを常に&#8221;1&#8221;とする設定です。</p>
</div></blockquote>
<p><strong>anomaly.java</strong></p>
<blockquote>
<div><p>anomaly.javaでは、textから読み込んだデータをJubatusサーバ与え、外れ値を検出し出力します。</p>
<ol class="arabic simple">
<li>Jubatus Serverへの接続設定</li>
</ol>
<blockquote>
<div>Jubatus Serverへの接続を行います（116行目）。
Jubatus ServerのIPアドレス、Jubatus ServerのRPCポート番号、接続待機時間を設定します。</div></blockquote>
<ol class="arabic simple" start="2">
<li>学習用データの準備</li>
</ol>
<blockquote>
<div><p>AnomalyClientでは、Datumをaddメソッドに与えることで、学習および外れ値検知が行われます。
今回はKDDカップ（Knowledge Discovery and Data Mining Cup）の結果（TEXTファイル）を元に学習用データを作成していきます。
まず、学習用データの元となるTEXTファイルを読み込みます。
ここでは、FileReaderとBuffererdReaderを利用して1行ずつループで読み込んで処理します（130-155行目）。
このTEXTファイルはカンマ区切りで項目が並んでいるので、取得した1行を’,’で分割し要素ごとに分けます（134行目）。
定義したTEXTファイルの項目リスト（TEXT_COLUMN）とStringとDoubleの項目を定義したリスト（STRING_COLUMN、DOUBLE_COLUMN）を用い、型ごとにリストを作成します（137-143行目）。
作成した２つのリストを引数としてDatumを作成するprivateメソッド「makeDatum」を呼び出します（145行目）。</p>
<p>「makeDatum」では、String項目リストとDouble項目リストにデータを登録してdatumを作成します( 165-183行目)。定義しているString項目リスト（STRING_COLUMN）と引数のstrListの順番は対応しているので、addString(...)メソッドを使い、添字を揃えてdatumにStringを追加します。
Double項目リストもString項目と同様にaddNumber(...)メソッドを使い、添字を揃えてdatumにNumberを追加します。ここで明示的にDoubleに変換する必要があることに注意してください（175行目）。
これで、Datumの作成が完了しました。</p>
</div></blockquote>
<ol class="arabic simple" start="3">
<li>データの学習（学習モデルの更新）</li>
</ol>
<blockquote>
<div>AnomalyClientのaddメソッドに2. で作成したデータを渡します（147行目）
戻り値として、tuple&lt;string, float&gt;型で点IDと異常値を返却します。</div></blockquote>
<ol class="arabic simple" start="4">
<li>結果の出力</li>
</ol>
<blockquote>
<div>addメソッドの戻り値である異常値から外れ値かどうかを判定します（151行目）。
異常値が無限ではなく、1.0以外の場合は外れ値と判断し出力します（152行目）。</div></blockquote>
</div></blockquote>
</div>
<div class="section" id="id3">
<h2>サンプルプログラムの実行<a class="headerlink" href="#id3" title="このヘッドラインへのパーマリンク">¶</a></h2>
<p><strong>[データのダウンロード]</strong></p>
<blockquote>
<div><div class="highlight-default"><div class="highlight"><pre><span></span>$ wget http://kdd.ics.uci.edu/databases/kddcup99/kddcup.data_10_percent.gz
$ gunzip kddcup.data_10_percent.gz
$ mv kddcup.data_10_percent kddcup.data_10_percent.txt
</pre></div>
</div>
</div></blockquote>
<p><strong>［Jubatus Serverでの作業］</strong></p>
<blockquote>
<div><p>jubaanomalyを起動します。</p>
<div class="highlight-default"><div class="highlight"><pre><span></span>$ jubaanomaly --configpath config.json
</pre></div>
</div>
</div></blockquote>
<p><strong>［Jubatus Clientでの作業］</strong></p>
<blockquote>
<div>必要なパッケージとJavaクライアントを用意し、実行します。
詳しくは <a class="reference external" href="https://github.com/jubatus/jubatus-example/tree/master/network_intrusion_detection">Jubatus Example</a> をご覧ください。</div></blockquote>
<p><strong>［実行結果］</strong></p>
<blockquote>
<div><div class="highlight-default"><div class="highlight"><pre><span></span>(&#39;194&#39;, 1.0000441074371338) normal.
(&#39;494&#39;, 1.4595649242401123) normal.
(&#39;1127&#39;, 1.0642377138137817) normal.
(&#39;1148&#39;, 1.0404019355773926) normal.
(&#39;1709&#39;, 1.2717968225479126) normal.
(&#39;2291&#39;, 1.388629674911499) normal.
(&#39;2357&#39;, 1.0560613870620728) normal.
(&#39;2382&#39;, 0.9994010925292969) normal.
(&#39;2499&#39;, 0.7581642270088196) normal.


…（以下略）
</pre></div>
</div>
</div></blockquote>
</div>
</div>


           </div>
          </div>
          <footer>
  
    <div class="rst-footer-buttons" role="navigation" aria-label="footer navigation">
      
        <a href="regression.html" class="btn btn-neutral float-right" title="Regression チュートリアル" accesskey="n">Next <span class="fa fa-arrow-circle-right"></span></a>
      
      
        <a href="anomaly_ruby.html" class="btn btn-neutral" title="Anomaly チュートリアル (Ruby)" accesskey="p"><span class="fa fa-arrow-circle-left"></span> Previous</a>
      
    </div>
  

  <hr/>

  <div role="contentinfo">
    <p>
        &copy; Copyright 2011-2016 PFN &amp; NTT.

    </p>
  </div>
  Built with <a href="http://sphinx-doc.org/">Sphinx</a> using a <a href="https://github.com/snide/sphinx_rtd_theme">theme</a> provided by <a href="https://readthedocs.org">Read the Docs</a>. 

</footer>

        </div>
      </div>

    </section>

  </div>
  


  

    <script type="text/javascript">
        var DOCUMENTATION_OPTIONS = {
            URL_ROOT:'../',
            VERSION:'1.0.0',
            COLLAPSE_INDEX:false,
            FILE_SUFFIX:'.html',
            HAS_SOURCE:  true
        };
    </script>
      <script type="text/javascript" src="../_static/jquery.js"></script>
      <script type="text/javascript" src="../_static/underscore.js"></script>
      <script type="text/javascript" src="../_static/doctools.js"></script>
      <script type="text/javascript" src="../_static/translations.js"></script>
      <script type="text/javascript" src="https://cdn.mathjax.org/mathjax/latest/MathJax.js?config=TeX-AMS-MML_HTMLorMML"></script>

  

  
  
    <script type="text/javascript" src="../_static/js/theme.js"></script>
  

  
  
  <script type="text/javascript">
      jQuery(function () {
          SphinxRtdTheme.StickyNav.enable();
      });
  </script>
   

</body>
</html>