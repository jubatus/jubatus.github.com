
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN"
  "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">

<html xmlns="http://www.w3.org/1999/xhtml">
  <head>
    <meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
    
    <title>RPC エラーのハンドリング &mdash; Jubatus</title>
    <link rel="stylesheet" href="_static/jubatus.css" type="text/css" />
    <link rel="stylesheet" href="_static/pygments.css" type="text/css" />

    
<script type="text/javascript">
   var GuideSentence = 'keyword';
   function ShowFormGuide(obj) {
      if( obj.value == '' ) {
         obj.value = GuideSentence;
         obj.style.color = '#cccccc';
      }else{
         obj.style.color = '#333333';
      }
   }
   function HideFormGuide(obj) {
      obj.style.color = '#827046';
      if( obj.value == GuideSentence ) {
         obj.value='';   
      }
   }
</script>
    <script type="text/javascript">
      var DOCUMENTATION_OPTIONS = {
        URL_ROOT:    './',
        VERSION:     '0.9.0',
        COLLAPSE_INDEX: false,
        FILE_SUFFIX: '.html',
        HAS_SOURCE:  true
      };
    </script>
    <script type="text/javascript" src="_static/jquery.js"></script>
    <script type="text/javascript" src="_static/underscore.js"></script>
    <script type="text/javascript" src="_static/doctools.js"></script>
    <script type="text/javascript" src="_static/translations.js"></script>
    <link rel="shortcut icon" href="_static/favicon.ico"/>
    <link rel="top" title="Jubatus" href="index.html" />
    <link rel="up" title="ドキュメント" href="documentation.html" />
    <link rel="next" title="学習モデルのバックアップとリカバリ" href="backup_and_recovery.html" />
    <link rel="prev" title="MIX 戦略" href="mix_strategy.html" /> 

<!--

   _________         ___
   \____   _|       | /             ___I_I___
       |  |         | |             \__^ ^__/        ____
       |  |         | | ___    ___  __ | |          / __/
       |  | |-|  |-|| |/   \  /   \| | | | |^|  |^|| (__
       |  | | |  | ||    ^  ||  ^    | | | | |  | | \__ \
       |  | | \_/  ||    O   || O    | | |_| \_/  | ___) |
       |  |  \__/|_||_|\___/  \___/|_| |__/ \__/|_| \___/
       | /
      / /
     |/

-->
  <script type="text/javascript">

  var _gaq = _gaq || [];
  _gaq.push(['_setAccount', 'UA-26408953-1']);
  _gaq.push(['_trackPageview']);

  (function() {
    var ga = document.createElement('script'); ga.type = 'text/javascript'; ga.async = true;
    ga.src = ('https:' == document.location.protocol ? 'https://ssl' : 'http://www') + '.google-analytics.com/ga.js';
    var s = document.getElementsByTagName('script')[0]; s.parentNode.insertBefore(ga, s);
  })();

  </script>
  </head>
  <body>
    <div class="related">
      <h3>ナビゲーション</h3>
      <ul>
        <li class="right" style="margin-right: 10px">
          <a href="genindex.html" title="総合索引"
             accesskey="I">索引</a></li>
        <li class="right" >
          <a href="rb-modindex.html" title="Ruby Module Index"
             >モジュール</a> |</li>
        <li class="right" >
          <a href="backup_and_recovery.html" title="学習モデルのバックアップとリカバリ"
             accesskey="N">次へ</a> |</li>
        <li class="right" >
          <a href="mix_strategy.html" title="MIX 戦略"
             accesskey="P">前へ</a> |</li>
        <li><a href="index.html">Jubatus</a> &raquo;</li>
          <li><a href="documentation.html" accesskey="U">ドキュメント</a> &raquo;</li> 
      </ul>
    </div>
          
		<a href="index.html">
			 <div class="title"></div>
		</a>
      <div class="sphinxsidebar">
        <div class="sphinxsidebarwrapper">
  <h3><a href="index.html">目次</a></h3>
  <ul>
<li><a class="reference internal" href="#">RPC エラーのハンドリング</a><ul>
<li><a class="reference internal" href="#id1">共通</a></li>
<li><a class="reference internal" href="#id2">クライアント言語別 推奨手順</a><ul>
<li><a class="reference internal" href="#ruby">Ruby</a></li>
<li><a class="reference internal" href="#python">Python</a></li>
<li><a class="reference internal" href="#c">C++</a></li>
<li><a class="reference internal" href="#java">Java</a></li>
</ul>
</li>
</ul>
</li>
</ul>

  <h4>前のトピックへ</h4>
  <p class="topless"><a href="mix_strategy.html"
                        title="前の章へ">MIX 戦略</a></p>
  <h4>次のトピックへ</h4>
  <p class="topless"><a href="backup_and_recovery.html"
                        title="次の章へ">学習モデルのバックアップとリカバリ</a></p>
  <div role="note" aria-label="source link">
    <h3>このページ</h3>
    <ul class="this-page-menu">
      <li><a href="_sources/faq_rpc_err_workaround.txt"
            rel="nofollow">ソースコードを表示</a></li>
    </ul>
   </div>
          <div id="searchbox" style="display: none">
            <h3>Quick Search</h3>
              <form class="search" action="search.html" method="get">
                <input type="text" name="q" size="18" class="keyword" value="keyword" onFocus="HideFormGuide(this);" onBlur="ShowFormGuide(this);" />
                <input type="submit" value="Go" class="searchBtn" />
                <input type="hidden" name="check_keywords" value="yes" />
                <input type="hidden" name="area" value="default" />
              </form>
              <p class="searchtip" style="font-size: 90%">
              </p>
          </div>
          <script type="text/javascript">$('#searchbox').show(0);</script>
	  
          

<a class="twitter-timeline" data-dnt="true" href="https://twitter.com/JubatusOfficial"  data-widget-id="258379257628196864">Tweets by @JubatusOfficial</a>
<script>!function(d,s,id){var js,fjs=d.getElementsByTagName(s)[0];if(!d.getElementById(id)){js=d.createElement(s);js.id=id;js.src="//platform.twitter.com/widgets.js";fjs.parentNode.insertBefore(js,fjs);}}(document,"script","twitter-wjs");</script>
        </div>
      </div>

    <div class="document">
      <div class="documentwrapper">
        <div class="bodywrapper">
          <div class="body">
            
  <div class="section" id="rpc">
<h1>RPC エラーのハンドリング<a class="headerlink" href="#rpc" title="このヘッドラインへのパーマリンク">¶</a></h1>
<p>Jubatus では、様々な理由で RPCエラー が発生します（このうち、とくによく遭遇するのが サーバが接続を自動的に切断したことで発生するタイムアウトエラーでしょう）。
ここでは RPCエラーハンドリングの推奨手順を記載します。</p>
<div class="section" id="id1">
<h2>共通<a class="headerlink" href="#id1" title="このヘッドラインへのパーマリンク">¶</a></h2>
<ul class="simple">
<li>RPCを行うと、例外が発生する可能性があります。
一部の言語では、例外が発生した場合でも自動的には接続が破棄されません。
リソース漏れのないアプリケーションを作成するためには、必ず例外を捕捉し、明示的に接続を破棄するようにしてください。
これはクライアントオブジェクト利用終了時も同様です。</li>
<li>RPCで発生する例外は、メソッド名や型の不一致などアプリケーション層の問題に起因するものと、タイムアウトや通信エラーなどトランスポート層以下の問題に起因するものがあります。
このうちトランスポート層の問題に起因するものは、例外が発生したRPCを再実行することで復旧する可能性があります。</li>
<li>RPCの再実行を行う場合は、以下の点を検討する必要があります:<ul>
<li><strong>UPDATE系メソッドの再実行可否</strong> :
一般に、冪等性のない UPDATE系メソッドを再実行すると、学習結果が異なってしまう可能性があります。
実際には学習が行われなかったUPDATE系メソッドだけ再実行することが出来れば良いのですが、現在の Jubatus では、クライアント側でこれを判別することはできません。
したがって、UPDATE系メソッドの再実行は、冪等性が保証されたメソッドに限定すべきです。
なお、ANALYZE系メソッドの再実行にはとくに制限はありません。</li>
<li><strong>応答性低下</strong> :
RPCの再実行を行うと、その分応答性が低下します。該当アプリケーションでRPC再実行に伴う応答性低下が許されるかどうかを検討する必要があります。</li>
</ul>
</li>
<li>RPC再実行は、間隔をおいて行い、再実行の上限回数を設けることを推奨します。</li>
</ul>
</div>
<div class="section" id="id2">
<h2>クライアント言語別 推奨手順<a class="headerlink" href="#id2" title="このヘッドラインへのパーマリンク">¶</a></h2>
<div class="section" id="ruby">
<h3>Ruby<a class="headerlink" href="#ruby" title="このヘッドラインへのパーマリンク">¶</a></h3>
<ul class="simple">
<li>RPC呼び出しを行うコードは、 <code class="docutils literal"><span class="pre">begin</span> <span class="pre">-</span> <span class="pre">ensure</span></code> ブロックにより、接続の明示的な破棄を保証するようにします。
接続の明示的な破棄には、クライアントオブジェクトの <code class="docutils literal"><span class="pre">get_client.close</span></code> を使います。</li>
<li>RPC呼び出しで発生するすべての例外は、 <code class="docutils literal"><span class="pre">MessagePack::RPC::RPCError</span></code> から派生しています。</li>
<li>RPC呼び出しで、トランスポート層のエラーが発生した場合は <code class="docutils literal"><span class="pre">MessagePack::RPC::TransportError</span></code> が発生します。
また、タイムアウトが発生した場合は <code class="docutils literal"><span class="pre">MessagePack::RPC::TimeoutError</span></code> が発生します。
サーバにより自動的に接続破棄された場合も <code class="docutils literal"><span class="pre">MessagePack::RPC::TimeoutError</span></code> が発生します。
<code class="docutils literal"><span class="pre">begin</span> <span class="pre">-</span> <span class="pre">rescue</span></code> ブロックでこれらの例外を捕捉し、RPCを再実行します。RPC再実行を行うためには、接続を一旦明示的に破棄する必要があります。</li>
<li>RPC呼び出しで、メソッド名や型の不一致が発生した場合は <code class="docutils literal"><span class="pre">Jubatus::Common::InterfaceMismatch</span></code> 例外が発生します。
アルゴリズムのエラーが発生した場合は <code class="docutils literal"><span class="pre">MessagePack::RPC::RemoteError</span></code> または <code class="docutils literal"><span class="pre">MessagePack::RPC::CallError</span></code> 例外が発生します。
これらの例外を捕捉し、接続を明示的に破棄します。 <code class="docutils literal"><span class="pre">TransportError</span></code> および <code class="docutils literal"><span class="pre">TimeoutError</span></code> 以外の <code class="docutils literal"><span class="pre">RPCError</span></code> をまとめて捕捉してもよいでしょう。</li>
</ul>
<div class="highlight-ruby"><div class="highlight"><pre><span></span><span class="nb">require</span> <span class="s1">&#39;jubatus/classifier/client&#39;</span>

<span class="no">RETRY_MAX</span> <span class="o">=</span> <span class="mi">3</span>      <span class="c1"># 再実行の上限回数</span>
<span class="no">RETRY_INTERVAL</span> <span class="o">=</span> <span class="mi">3</span> <span class="c1"># 再実行の間隔(秒)</span>

<span class="n">client</span> <span class="o">=</span> <span class="no">Jubatus</span><span class="o">::</span><span class="no">Classifier</span><span class="o">::</span><span class="no">Client</span><span class="o">::</span><span class="no">Classifier</span><span class="o">.</span><span class="n">new</span><span class="p">(</span><span class="n">host</span><span class="p">,</span> <span class="n">port</span><span class="p">,</span> <span class="nb">name</span><span class="p">,</span> <span class="n">timeout</span><span class="p">)</span>
<span class="k">begin</span>
  <span class="n">retry_count</span> <span class="o">=</span> <span class="no">RETRY_MAX</span>
  <span class="k">begin</span>

    <span class="c1"># RPC実行</span>
    <span class="n">client</span><span class="o">.</span><span class="n">classify</span><span class="p">(</span><span class="n">query_data</span><span class="p">)</span>

  <span class="c1"># トランスポート層エラーとタイムアウトは再実行する</span>
  <span class="k">rescue</span> <span class="no">MessagePack</span><span class="o">::</span><span class="no">RPC</span><span class="o">::</span><span class="no">TimeoutError</span><span class="p">,</span> <span class="no">MessagePack</span><span class="o">::</span><span class="no">RPC</span><span class="o">::</span><span class="no">TransportError</span> <span class="o">=&gt;</span> <span class="n">e</span>
    <span class="c1"># 再実行回数の上限に達したら諦める</span>
    <span class="k">raise</span> <span class="k">if</span> <span class="p">(</span><span class="n">retry_count</span> <span class="o">-=</span> <span class="mi">1</span><span class="p">)</span> <span class="o">&lt;=</span> <span class="mi">0</span>

    <span class="c1"># 再実行準備: 一旦 接続を明示的に破棄</span>
    <span class="n">client</span><span class="o">.</span><span class="n">get_client</span><span class="o">.</span><span class="n">close</span>

    <span class="c1"># 間隔をおいて再実行</span>
    <span class="vg">$stderr</span><span class="o">.</span><span class="n">puts</span> <span class="n">e</span>
    <span class="nb">sleep</span> <span class="no">RETRY_INTERVAL</span>
    <span class="k">retry</span>
  <span class="k">end</span>

<span class="c1"># すべての RPCエラーを捕捉</span>
<span class="k">rescue</span> <span class="no">MessagePack</span><span class="o">::</span><span class="no">RPC</span><span class="o">::</span><span class="no">RPCError</span><span class="p">,</span> <span class="no">Jubatus</span><span class="o">::</span><span class="no">Common</span><span class="o">::</span><span class="no">InterfaceMismatch</span> <span class="o">=&gt;</span> <span class="n">e</span>
  <span class="vg">$stderr</span><span class="o">.</span><span class="n">puts</span> <span class="n">e</span>
<span class="k">ensure</span>
  <span class="c1"># 接続は必ず破棄</span>
  <span class="n">client</span><span class="o">.</span><span class="n">get_client</span><span class="o">.</span><span class="n">close</span>
<span class="k">end</span>
</pre></div>
</div>
</div>
<div class="section" id="python">
<h3>Python<a class="headerlink" href="#python" title="このヘッドラインへのパーマリンク">¶</a></h3>
<ul class="simple">
<li>RPC呼び出しを行うコードは、 <code class="docutils literal"><span class="pre">try</span> <span class="pre">-</span> <span class="pre">finally</span></code> ブロックにより、接続の明示的な破棄を保証するようにします。
接続の明示的な破棄には、クライアントオブジェクトの <code class="docutils literal"><span class="pre">get_client().close()</span></code> を使います。</li>
<li>RPC呼び出しで発生する全ての例外は、 <code class="docutils literal"><span class="pre">msgpackrpc.error.RPCError</span></code> から派生しています。</li>
<li>RPC呼び出しで、トランスポート層のエラーが発生した場合は <code class="docutils literal"><span class="pre">msgpackrpc.error.TransportError</span></code> が発生します。
また、タイムアウトが発生した場合は <code class="docutils literal"><span class="pre">msgpackrpc.error.TimeoutError</span></code> が発生します。
サーバにより自動的に接続破棄された場合も <code class="docutils literal"><span class="pre">msgpackrpc.error.TimeoutError</span></code> が発生します。
<code class="docutils literal"><span class="pre">try</span> <span class="pre">-</span> <span class="pre">except</span></code> ブロックでこれらの例外を捕捉し、RPCを再実行します。RPC再実行を行うためには、接続を一旦明示的に破棄し、さらに <strong>クライアントオブジェクトを再生成する必要があります</strong> 。</li>
<li>RPC呼び出しで、メソッド名や型の不一致が発生した場合は、 <code class="docutils literal"><span class="pre">jubatus.common.client.InterfaceMismatch</span></code> が発生します。
アルゴリズムのエラーやその他のエラーが発生した場合は <code class="docutils literal"><span class="pre">msgpackrpc.error.RPCError</span></code> が発生します。
これらの例外を捕捉し、接続を明示的に破棄します。 <code class="docutils literal"><span class="pre">TransportError</span></code> および <code class="docutils literal"><span class="pre">TimeoutError</span></code> 以外の <code class="docutils literal"><span class="pre">RPCError</span></code> をまとめて捕捉してもよいでしょう。</li>
</ul>
<div class="highlight-python"><div class="highlight"><pre><span></span><span class="kn">import</span> <span class="nn">jubatus</span>
<span class="kn">from</span> <span class="nn">jubatus.common</span> <span class="kn">import</span> <span class="n">Datum</span>
<span class="kn">import</span> <span class="nn">msgpackrpc</span>
<span class="kn">import</span> <span class="nn">time</span>

<span class="n">retry_max</span> <span class="o">=</span> <span class="mi">3</span>      <span class="c1"># 再実行の上限回数</span>
<span class="n">retry_interval</span> <span class="o">=</span> <span class="mi">3</span> <span class="c1"># 再実行の間隔(秒)</span>

<span class="n">client</span> <span class="o">=</span> <span class="n">jubatus</span><span class="o">.</span><span class="n">Classifier</span><span class="p">(</span><span class="n">host</span><span class="p">,</span> <span class="n">port</span><span class="p">,</span> <span class="n">name</span><span class="p">,</span> <span class="n">timeout</span><span class="p">)</span>
<span class="k">try</span><span class="p">:</span>
    <span class="n">retry_count</span> <span class="o">=</span> <span class="n">retry_max</span>
    <span class="k">while</span> <span class="bp">True</span><span class="p">:</span>
        <span class="k">try</span><span class="p">:</span>

            <span class="c1"># RPC実行</span>
            <span class="n">client</span><span class="o">.</span><span class="n">classify</span><span class="p">(</span><span class="n">query_data</span><span class="p">)</span>
            <span class="k">break</span>

        <span class="c1"># トランスポート層エラーとタイムアウトは再実行する</span>
        <span class="k">except</span> <span class="p">(</span><span class="n">msgpackrpc</span><span class="o">.</span><span class="n">error</span><span class="o">.</span><span class="n">TransportError</span><span class="p">,</span> <span class="n">msgpackrpc</span><span class="o">.</span><span class="n">error</span><span class="o">.</span><span class="n">TimeoutError</span><span class="p">)</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
            <span class="c1"># 再実行回数の上限に達したら諦める</span>
            <span class="n">retry_count</span> <span class="o">-=</span> <span class="mi">1</span>
            <span class="k">if</span> <span class="n">retry_count</span> <span class="o">&lt;=</span> <span class="mi">0</span><span class="p">:</span>
                <span class="k">raise</span>

            <span class="c1"># 再実行の準備: 接続を明示的に破棄し、クライアントオブジェクト再生成</span>
            <span class="n">client</span><span class="o">.</span><span class="n">get_client</span><span class="p">()</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
            <span class="n">client</span> <span class="o">=</span> <span class="n">jubatus</span><span class="o">.</span><span class="n">Classifier</span><span class="p">(</span><span class="n">host</span><span class="p">,</span> <span class="n">port</span><span class="p">,</span> <span class="n">name</span><span class="p">,</span> <span class="n">timeout</span><span class="p">)</span>

            <span class="c1"># 間隔をおいて再実行</span>
            <span class="k">print</span> <span class="n">e</span>
            <span class="n">time</span><span class="o">.</span><span class="n">sleep</span><span class="p">(</span><span class="n">retry_interval</span><span class="p">)</span>
            <span class="k">continue</span>

<span class="c1"># 全ての RPCエラーを捕捉</span>
<span class="k">except</span> <span class="p">(</span><span class="n">msgpackrpc</span><span class="o">.</span><span class="n">error</span><span class="o">.</span><span class="n">RPCError</span><span class="p">,</span> <span class="n">jubatus</span><span class="o">.</span><span class="n">common</span><span class="o">.</span><span class="n">client</span><span class="o">.</span><span class="n">InterfaceMismatch</span><span class="p">)</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
    <span class="k">print</span> <span class="n">e</span>

<span class="k">finally</span><span class="p">:</span>
    <span class="c1"># 接続は必ず破棄</span>
    <span class="n">client</span><span class="o">.</span><span class="n">get_client</span><span class="p">()</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="section" id="c">
<h3>C++<a class="headerlink" href="#c" title="このヘッドラインへのパーマリンク">¶</a></h3>
<ul class="simple">
<li>クライアントオブジェクトを破棄することで、接続は自動的に破棄されます。
明示的に接続破棄を行う必要はありません。明示的に接続破棄を行う場合は、クライアントオブジェクトの <code class="docutils literal"><span class="pre">get_client().close()</span></code> を使います。</li>
<li>RPC呼び出しで発生するすべての例外は、 <code class="docutils literal"><span class="pre">msgpack::rpc::rpc_error</span></code> から派生しています。</li>
<li>RPC呼び出しで発生するトランスポート層のエラーのうち、サーバ接続に失敗した場合は、 <code class="docutils literal"><span class="pre">msgpack::rpc::connect_error</span></code> が発生します。
その他のトランスポート層のエラーの場合は <code class="docutils literal"><span class="pre">msgpack::rpc::system_error</span></code> が発生します。
また、タイムアウトが発生した場合は <code class="docutils literal"><span class="pre">msgpack::rpc::timeout_error</span></code> が発生します。
サーバにより自動的に接続破棄された場合は、 <code class="docutils literal"><span class="pre">msgpack::rpc::connection_closed_error</span></code> が発生します。
<code class="docutils literal"><span class="pre">try</span> <span class="pre">-</span> <span class="pre">catch</span></code> ブロックでこれらの例外を補足し、RPCを再実行します。再実行するためには、接続を一旦明示的に破棄する必要があります。
なお、 <code class="docutils literal"><span class="pre">connect_error</span></code> は <code class="docutils literal"><span class="pre">timeout_error</span></code> から派生しています。 <code class="docutils literal"><span class="pre">connect_error</span></code> を <code class="docutils literal"><span class="pre">timeout_error</span></code> として捕捉することができます。</li>
<li>RPC呼び出しで、メソッド名がや型の不一致の場合、それぞれ <code class="docutils literal"><span class="pre">msgpack::rpc::no_method_error</span></code>, <code class="docutils literal"><span class="pre">msgpack::rpc::argument_error</span></code> が発生します。
アルゴリズムのエラーが発生した場合は、 <code class="docutils literal"><span class="pre">msgpack::rpc::remote_error</span></code> 例外が発生します。
これらの例外を <code class="docutils literal"><span class="pre">rpc_error</span></code> としてまとめて捕捉してもよいでしょう。</li>
</ul>
<div class="highlight-c++"><div class="highlight"><pre><span></span><span class="cp">#include</span> <span class="cpf">&lt;jubatus/client.hpp&gt;</span><span class="cp"></span>

<span class="cp">#define RETRY_MAX 3       </span><span class="c1">// 再実行の上限回数</span>
<span class="cp">#define RETRY_INTERVAL 3  </span><span class="c1">// 再実行の間隔(秒)</span>

<span class="c1">// 例外ハンドラ マクロ</span>
<span class="cp">#define RPC_RETRY_EXCEPTION_COMMON_HANDLER()    \</span>
<span class="cp">    </span><span class="c1">// 再実行回数の上限に達したら諦める         \</span>
    <span class="k">if</span> <span class="p">(</span><span class="o">--</span><span class="n">retry_count</span> <span class="o">&lt;=</span> <span class="mi">0</span><span class="p">)</span> <span class="k">throw</span><span class="p">;</span>              \
                                                \
    <span class="c1">// 再実行の準備: 一旦 接続を明示的に破棄    \</span>
<span class="c1">    client.get_client().close();                \</span>
<span class="c1">                                                \</span>
<span class="c1">    // 間隔をおいて再実行                       \</span>
<span class="c1">    std::cerr &lt;&lt; e.what() &lt;&lt; std::endl;         \</span>
<span class="c1">    ::sleep(RETRY_INTERVAL);                    \</span>
<span class="c1">    continue;</span>

<span class="p">{</span>
  <span class="n">jubatus</span><span class="o">::</span><span class="n">classifier</span><span class="o">::</span><span class="n">client</span><span class="o">::</span><span class="n">classifier</span> <span class="n">client</span><span class="p">(</span><span class="n">host</span><span class="p">,</span> <span class="n">port</span><span class="p">,</span> <span class="n">name</span><span class="p">,</span> <span class="n">timeout</span><span class="p">);</span>
  <span class="k">try</span> <span class="p">{</span>
    <span class="kt">int</span> <span class="n">retry_count</span> <span class="o">=</span> <span class="n">RETRY_MAX</span><span class="p">;</span>
    <span class="k">while</span><span class="p">(</span><span class="nb">true</span><span class="p">)</span> <span class="p">{</span>
      <span class="k">try</span> <span class="p">{</span>

        <span class="c1">// RPC実行</span>
        <span class="n">results</span> <span class="o">=</span> <span class="n">client</span><span class="p">.</span><span class="n">classify</span><span class="p">(</span><span class="n">query_data</span><span class="p">);</span>
        <span class="k">break</span><span class="p">;</span>
      <span class="c1">// トランスポート層のエラーとタイムアウトは再実行する</span>
      <span class="p">}</span> <span class="k">catch</span><span class="p">(</span><span class="n">msgpack</span><span class="o">::</span><span class="n">rpc</span><span class="o">::</span><span class="n">connection_closed_error</span> <span class="o">&amp;</span><span class="n">e</span><span class="p">)</span> <span class="p">{</span>
        <span class="n">RPC_RETRY_EXCEPTION_COMMON_HANDLER</span><span class="p">();</span>
      <span class="p">}</span> <span class="k">catch</span><span class="p">(</span><span class="n">msgpack</span><span class="o">::</span><span class="n">rpc</span><span class="o">::</span><span class="n">system_error</span> <span class="o">&amp;</span><span class="n">e</span><span class="p">)</span> <span class="p">{</span>
        <span class="n">RPC_RETRY_EXCEPTION_COMMON_HANDLER</span><span class="p">();</span>
      <span class="p">}</span> <span class="k">catch</span><span class="p">(</span><span class="n">msgpack</span><span class="o">::</span><span class="n">rpc</span><span class="o">::</span><span class="n">timeout_error</span> <span class="o">&amp;</span><span class="n">e</span><span class="p">)</span> <span class="p">{</span>
        <span class="n">RPC_RETRY_EXCEPTION_COMMON_HANDLER</span><span class="p">();</span>
      <span class="p">}</span>
    <span class="p">}</span>

  <span class="c1">// 全ての RPCエラーを捕捉</span>
  <span class="p">}</span> <span class="k">catch</span><span class="p">(</span><span class="n">msgpack</span><span class="o">::</span><span class="n">rpc</span><span class="o">::</span><span class="n">rpc_error</span> <span class="o">&amp;</span><span class="n">e</span><span class="p">)</span> <span class="p">{</span>
    <span class="n">std</span><span class="o">::</span><span class="n">cerr</span> <span class="o">&lt;&lt;</span> <span class="n">e</span><span class="p">.</span><span class="n">what</span><span class="p">()</span> <span class="o">&lt;&lt;</span> <span class="n">std</span><span class="o">::</span><span class="n">endl</span><span class="p">;</span>
  <span class="p">}</span>
  <span class="c1">// クライアントオブジェクト破棄で 接続は自動的に破棄される</span>
<span class="p">}</span>
</pre></div>
</div>
</div>
<div class="section" id="java">
<h3>Java<a class="headerlink" href="#java" title="このヘッドラインへのパーマリンク">¶</a></h3>
<ul class="simple">
<li>RPC呼び出しを行うコードは、try - finally構文により、接続の明示的な破棄を保証するようにします。
接続の明示的な破棄には、クライアントオブジェクトの <code class="docutils literal"><span class="pre">get_client().close()</span></code> を使います。</li>
<li>現在、RPC呼び出しで発生する全ての例外は、 <code class="docutils literal"><span class="pre">org.msgpack.rpc.error.RPCError</span></code> によって報告されます。
例外クラスによってエラーを分類することはできません。 <code class="docutils literal"><span class="pre">RPCError</span></code> を捕捉し、接続を明示的に破棄します。</li>
<li>接続を明示的に破棄した後、同じクライアントオブジェクトを使ってRPCを再実行することができます。
しかし、再実行により復旧の可能性があるトランスポート層のエラーのみを切り分けて再実行することができないので推奨いたしません。</li>
</ul>
</div>
</div>
</div>


          </div>
        </div>
      </div>
      <div class="clearer"></div>
    </div>
    <div class="related">
      <h3>ナビゲーション</h3>
      <ul>
        <li class="right" style="margin-right: 10px">
          <a href="genindex.html" title="総合索引"
             >索引</a></li>
        <li class="right" >
          <a href="rb-modindex.html" title="Ruby Module Index"
             >モジュール</a> |</li>
        <li class="right" >
          <a href="backup_and_recovery.html" title="学習モデルのバックアップとリカバリ"
             >次へ</a> |</li>
        <li class="right" >
          <a href="mix_strategy.html" title="MIX 戦略"
             >前へ</a> |</li>
        <li><a href="index.html">Jubatus</a> &raquo;</li>
          <li><a href="documentation.html" >ドキュメント</a> &raquo;</li> 
      </ul>
    </div>
    <div class="footer">
        &copy; Copyright 2011-2016 PFN &amp; NTT.
      Created using <a href="http://sphinx.pocoo.org/">Sphinx</a> 1.4.1.
    </div>

    <!-- https://github.com/blog/273-github-ribbons -->
    <a href="http://github.com/jubatus/jubatus">
      <img style="position: absolute; top: 0; right: 0; border: 0;" src="https://s3.amazonaws.com/github/ribbons/forkme_right_green_007200.png" alt="Fork me on GitHub" />
      </a>
  </body>
</html>