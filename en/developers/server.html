

<!DOCTYPE html>
<!--[if IE 8]><html class="no-js lt-ie9" lang="en" > <![endif]-->
<!--[if gt IE 8]><!--> <html class="no-js" lang="en" > <!--<![endif]-->
<head>
  <meta charset="utf-8">
  
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  
  <title>Using Code Generators &mdash; Jubatus</title>
  

  
  
    <link rel="shortcut icon" href="../_static/favicon.ico"/>
  

  

  
  
    

  

  
  
    <link rel="stylesheet" href="../_static/css/theme.css" type="text/css" />
  

  
    <link rel="stylesheet" href="../_static/custom.css" type="text/css" />
  

  
    <link rel="top" title="Jubatus" href="../index.html"/>
        <link rel="up" title="Using Framework" href="framework.html"/>
        <link rel="next" title="How to Get Clients" href="howtogetclients.html"/>
        <link rel="prev" title="Using Framework" href="framework.html"/> 

  
  <script src="../_static/js/modernizr.min.js"></script>

</head>

<body class="wy-body-for-nav" role="document">

  <div class="wy-grid-for-nav">

    
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search">
          

          
            <a href="../index.html" class="icon icon-home"> Jubatus
          

          
            
            <img src="../_static/title.png" class="logo" />
          
          </a>

          
            
            
          

          
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="../search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>

          
        </div>

        <div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="main navigation">
          
            
            
                <ul class="current">
<li class="toctree-l1"><a class="reference internal" href="../overview.html">Overview</a></li>
<li class="toctree-l1"><a class="reference internal" href="../quickstart.html">Quick Start</a></li>
<li class="toctree-l1"><a class="reference internal" href="../tutorial/index.html">Tutorial</a></li>
<li class="toctree-l1"><a class="reference internal" href="../tutorial_distributed.html">Distributed Mode</a></li>
<li class="toctree-l1"><a class="reference internal" href="../fv_convert.html">Data Conversion</a></li>
<li class="toctree-l1"><a class="reference internal" href="../method.html">Algorithms</a></li>
<li class="toctree-l1"><a class="reference internal" href="../commands/index.html">Commands</a></li>
<li class="toctree-l1"><a class="reference internal" href="../api/index.html">Client API</a></li>
<li class="toctree-l1"><a class="reference internal" href="../tips_faqs/index.html">Tips and FAQs</a></li>
<li class="toctree-l1 current"><a class="reference internal" href="index.html">Developer&#8217;s Guide</a><ul class="current">
<li class="toctree-l2"><a class="reference internal" href="build.html">Building Jubatus from Source</a></li>
<li class="toctree-l2"><a class="reference internal" href="plugin.html">Plugin Development</a></li>
<li class="toctree-l2 current"><a class="reference internal" href="framework.html">Using Framework</a><ul class="current">
<li class="toctree-l3 current"><a class="current reference internal" href="#">Using Code Generators</a><ul>
<li class="toctree-l4"><a class="reference internal" href="#flow-of-development">Flow of Development</a></li>
<li class="toctree-l4"><a class="reference internal" href="#why-we-use-idl">Why We Use IDL</a></li>
<li class="toctree-l4"><a class="reference internal" href="#composition-of-files">Composition of Files</a></li>
<li class="toctree-l4"><a class="reference internal" href="#jenerator-the-code-generator"><code class="docutils literal"><span class="pre">jenerator</span></code>: The Code Generator</a></li>
<li class="toctree-l4"><a class="reference internal" href="#implementing-server">Implementing Server</a></li>
<li class="toctree-l4"><a class="reference internal" href="#implementing-proxy">Implementing Proxy</a></li>
</ul>
</li>
<li class="toctree-l3"><a class="reference internal" href="howtogetclients.html">How to Get Clients</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="howtogetclients.html">How to Get Clients</a></li>
<li class="toctree-l2"><a class="reference internal" href="howtocontribute.html">How to Contribute</a></li>
<li class="toctree-l2"><a class="reference internal" href="cla.html">Jubatus Contributor License Agreement</a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="../jubakit/index.html">Jubakit</a></li>
<li class="toctree-l1"><a class="reference internal" href="../jubaql/index.html">JubaQL</a></li>
<li class="toctree-l1"><a class="reference internal" href="../about/index.html">About This Project</a></li>
</ul>

            
          
        </div>
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap">

      
      <nav class="wy-nav-top" role="navigation" aria-label="top navigation">
        <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
        <a href="../index.html">Jubatus</a>
      </nav>


      
      <div class="wy-nav-content">
        <div class="rst-content">
          

 



<div role="navigation" aria-label="breadcrumbs navigation">
  <ul class="wy-breadcrumbs">
    <li><a href="../index.html">Docs</a> &raquo;</li>
      
          <li><a href="index.html">Developer&#8217;s Guide</a> &raquo;</li>
      
          <li><a href="framework.html">Using Framework</a> &raquo;</li>
      
    <li>Using Code Generators</li>
      <li class="wy-breadcrumbs-aside">
        
          
        
      </li>
  </ul>
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
            
  <div class="section" id="using-code-generators">
<h1>Using Code Generators<a class="headerlink" href="#using-code-generators" title="Permalink to this headline">¶</a></h1>
<p>Development of machine learning algorithms using Jubatus framework starts with writing an IDL (RPC interface definition).
By using a code generator - <code class="docutils literal"><span class="pre">jenerator</span></code> (bundled tool with Jubatus)  - you can generate each component (server, proxy, client for each language) from the IDL.
By using this generator, framework users don&#8217;t need to focus on things other than implementing algorithms.</p>
<div class="section" id="flow-of-development">
<h2>Flow of Development<a class="headerlink" href="#flow-of-development" title="Permalink to this headline">¶</a></h2>
<ol class="arabic simple">
<li>Define RPC interfaces that the service should have using IDL.</li>
<li>Generate codes for server, proxy, common data structures and clients (C++/Python/Ruby/Java) with <code class="docutils literal"><span class="pre">jenerator</span></code> from IDL.</li>
<li>Implement codes of interface of user-defined class and (if necessary) mix operation.</li>
</ol>
<p>Use the <a class="reference external" href="https://github.com/jubatus/jubatus-service-skeleton">skeleton project</a> to get started.</p>
</div>
<div class="section" id="why-we-use-idl">
<h2>Why We Use IDL<a class="headerlink" href="#why-we-use-idl" title="Permalink to this headline">¶</a></h2>
<p>First, there must exist same definitions in six C++ source files every time we add new learning algorithm, that is, header and implementation of client, header and implementation of proxy and header and implementation of server.
This would lead to a &#8220;hotbed&#8221; of bugs every time we had changed the API.</p>
<p>By using IDL, users can create system through the flow above.
Currenly all algorithms (recommener, classifier, regression, stat and graph) defines its interface with <code class="docutils literal"><span class="pre">jenerator</span></code>.</p>
</div>
<div class="section" id="composition-of-files">
<h2>Composition of Files<a class="headerlink" href="#composition-of-files" title="Permalink to this headline">¶</a></h2>
<p>Machine learning system that uses Jubatus framework consists of the following files (where <em>NAME</em> is a name of the service).</p>
<ul class="simple">
<li>NAME_serv.cpp: Implementation of the server (edit template generated by <code class="docutils literal"><span class="pre">jenerator</span></code>)</li>
<li>NAME_serv.hpp: Header file for <code class="docutils literal"><span class="pre">NAME_serv.cpp</span></code> (edit template generated by <code class="docutils literal"><span class="pre">jenerator</span></code>)</li>
<li>NAME_impl.cpp: <code class="docutils literal"><span class="pre">main</span></code> function, RPC interface definition for the server and register RPC methods (automatically generated by <code class="docutils literal"><span class="pre">jenerator</span></code>)</li>
<li>NAME_proxy.cpp: Implementation of the proxy (automatically generated by <code class="docutils literal"><span class="pre">jenerator</span></code>)</li>
<li>NAME_client.hpp: Implementation of the client to be used in server-to-server communication (automatically generated by <code class="docutils literal"><span class="pre">jenerator</span></code>)</li>
<li>NAME_types.hpp: Structures and type information (automatically generated by <code class="docutils literal"><span class="pre">jenerator</span></code>)</li>
</ul>
</div>
<div class="section" id="jenerator-the-code-generator">
<h2><code class="docutils literal"><span class="pre">jenerator</span></code>: The Code Generator<a class="headerlink" href="#jenerator-the-code-generator" title="Permalink to this headline">¶</a></h2>
<p>The RPC interface is defined with <a class="reference external" href="https://github.com/msgpack/msgpack-haskell/blob/master/msgpack-idl/Specification.md">MessagePack-IDL</a>.
Aside from MessagePack-IDL&#8217;s original syntax, we must add annotations for each method of RPC service in order to generate Jubatus servers and proxies.</p>
<p>Annotations are interpreted by our code generator, called <code class="docutils literal"><span class="pre">jenerator</span></code>, but they are ignored as comments by MessagePack-IDL.
Therefore, we can generate each client with same interface by MessagePack-IDL.</p>
<p>Syntax of annotations for each methods is as follows.</p>
<ul class="simple">
<li>Each method must have 3 annotations, each of them starts with <code class="docutils literal"><span class="pre">#&#64;</span></code>, that specifies &#8220;routing&#8221;, &#8220;lock type&#8221; and &#8220;aggregation method&#8221; in order.</li>
<li>The &#8220;routing&#8221; annotation defines how Jubatus Proxy proxy requests.
Three methods (<code class="docutils literal"><span class="pre">cht</span></code>, <code class="docutils literal"><span class="pre">broadcast</span></code> or <code class="docutils literal"><span class="pre">random</span></code>) are available so that we can cover distribution methods used in typical machine learning tasks.<ul>
<li><code class="docutils literal"><span class="pre">cht</span></code> means that the request is distributed by using Consistent Hashing.
Methods annotated with <code class="docutils literal"><span class="pre">cht</span></code> must take at least 1 argument, which is a string that is used as a key for consistent hashing.
Replication level of updated data is 2 by default.
You can change the replication level by specifying like <code class="docutils literal"><span class="pre">#&#64;cht(1)</span></code>.</li>
<li><code class="docutils literal"><span class="pre">broadcast</span></code> means that the request will be broadcasted to all servers in the cluster.</li>
<li><code class="docutils literal"><span class="pre">random</span></code> means that the request will be proxied to one randomly-chosen server in the cluster.</li>
</ul>
</li>
<li>The &#8220;lock type&#8221; annotation defines read/write of request, and value must be one of <code class="docutils literal"><span class="pre">analysis</span></code>, <code class="docutils literal"><span class="pre">update</span></code> or <code class="docutils literal"><span class="pre">nolock</span></code>.<ul>
<li>When using <code class="docutils literal"><span class="pre">analysis</span></code>, data is locked in server with read lock and is accessible by multiple thread simultaneously.</li>
<li>When using <code class="docutils literal"><span class="pre">update</span></code>, data is locked with write lock, so that we can safely update the data.</li>
<li>When using <code class="docutils literal"><span class="pre">nolock</span></code>, no locks are aquired in the server.</li>
</ul>
</li>
<li>The &#8220;aggregation&#8221; annotation defines how to aggrate the results of API call from multiple servers.
Available aggregators are written in <a class="reference external" href="https://github.com/jubatus/jubatus/blob/master/jubatus/server/framework/aggregators.hpp">aggregators.hpp</a>.</li>
</ul>
<p><code class="docutils literal"><span class="pre">void</span></code> type cannot be used as the return type of methods.
If the return value is not needed, you must add meaningless type such as <code class="docutils literal"><span class="pre">int</span></code> or <code class="docutils literal"><span class="pre">bool</span></code>.</p>
<p>Here is a example of MessagePack-IDL with annotation.</p>
<div class="highlight-c++"><div class="highlight"><pre><span></span><span class="n">message</span> <span class="n">entry</span> <span class="p">{</span>
  <span class="mi">0</span><span class="o">:</span> <span class="n">string</span> <span class="n">key</span>
  <span class="mi">1</span><span class="o">:</span> <span class="n">string</span> <span class="n">value</span>
  <span class="mi">2</span><span class="o">:</span> <span class="kt">int</span> <span class="n">version</span>
<span class="p">}</span>

<span class="n">service</span> <span class="n">kvs</span> <span class="p">{</span>
  <span class="cp">#@cht(2) #@update #@pass</span>
  <span class="kt">int</span> <span class="n">put</span><span class="p">(</span><span class="mi">0</span><span class="o">:</span> <span class="n">string</span> <span class="n">key</span><span class="p">,</span> <span class="mi">1</span><span class="o">:</span> <span class="n">string</span> <span class="n">value</span><span class="p">)</span>

  <span class="cp">#@cht(2) #@analysis #@pass</span>
  <span class="n">entry</span> <span class="n">get</span><span class="p">(</span><span class="mi">0</span><span class="o">:</span> <span class="n">string</span> <span class="n">key</span><span class="p">)</span>

  <span class="cp">#@cht(2) #@update #@pass</span>
  <span class="kt">int</span> <span class="n">del</span><span class="p">(</span><span class="mi">0</span><span class="o">:</span> <span class="n">string</span> <span class="n">key</span><span class="p">,</span> <span class="mi">1</span><span class="o">:</span> <span class="kt">int</span> <span class="n">version</span><span class="p">)</span>

  <span class="cp">#@broadcast #@update #@pass</span>
  <span class="kt">int</span> <span class="n">clear</span><span class="p">()</span>
<span class="p">}</span>
</pre></div>
</div>
<p>The following RPC methods for server are automatically appended to each service by <code class="docutils literal"><span class="pre">jenerator</span></code>:</p>
<div class="highlight-c++"><div class="highlight"><pre><span></span><span class="cp">#@random #@analysis #@pass</span>
<span class="n">string</span> <span class="n">get_config</span><span class="p">()</span>

<span class="cp">#@broadcast #@analysis #@all_and</span>
<span class="kt">bool</span> <span class="n">save</span><span class="p">(</span><span class="mi">0</span><span class="o">:</span> <span class="n">string</span> <span class="n">id</span><span class="p">)</span>

<span class="cp">#@broadcast #@update #@all_and</span>
<span class="kt">bool</span> <span class="n">load</span><span class="p">(</span><span class="mi">0</span><span class="o">:</span> <span class="n">string</span> <span class="n">id</span><span class="p">)</span>

<span class="cp">#@broadcast #@analysis #@merge</span>
<span class="n">map</span><span class="o">&lt;</span><span class="n">string</span><span class="p">,</span> <span class="n">map</span><span class="o">&lt;</span><span class="n">string</span><span class="p">,</span> <span class="n">string</span><span class="o">&gt;</span> <span class="o">&gt;</span> <span class="n">get_status</span><span class="p">()</span>
</pre></div>
</div>
<div class="section" id="building-jenerator">
<h3>Building <code class="docutils literal"><span class="pre">jenerator</span></code><a class="headerlink" href="#building-jenerator" title="Permalink to this headline">¶</a></h3>
<p>You need OCaml &gt;=4.02.1 (with findlib), extlib and OMake and OUnit and ppx_deriving to build <code class="docutils literal"><span class="pre">jenerator</span></code>.
We recommend to use <a class="reference external" href="http://opam.ocaml.org/">OPAM</a> to make OCaml environment.
You have to use <a class="reference external" href="http://opam.ocaml.org/">OPAM</a> version 1.2 or more for installing modules which <code class="docutils literal"><span class="pre">jenerator</span></code> depends.
When you want to install OPAM from its source, <a class="reference external" href="https://github.com/ocaml/opam/wiki/Quick_Install#using-ocamlbrew">ocamlbrew</a> is usefull.</p>
<div class="highlight-default"><div class="highlight"><pre><span></span>$ opam switch 4.02.1
$ eval `opam config env`
$ opam install ocamlfind extlib omake ounit ppx_deriving
$ cd jubatus/tools/jenerator
$ omake
$ sudo omake install
</pre></div>
</div>
<p><code class="docutils literal"><span class="pre">omake</span> <span class="pre">install</span></code> installs <code class="docutils literal"><span class="pre">jenerator</span></code> as <code class="docutils literal"><span class="pre">/usr/local/bin/jenerator</span></code> (path may vary depending on your environment).
If you want to install <code class="docutils literal"><span class="pre">jenerator</span></code> to other directory, use <code class="docutils literal"><span class="pre">PREFIX</span></code> environment variable.</p>
<div class="highlight-default"><div class="highlight"><pre><span></span>$ PREFIX=/path/to/install omake install
</pre></div>
</div>
<p>You can also use built <code class="docutils literal"><span class="pre">jenerator</span></code> binary directly without installation.</p>
</div>
<div class="section" id="generating-server-proxy-from-idl">
<h3>Generating Server/Proxy from IDL<a class="headerlink" href="#generating-server-proxy-from-idl" title="Permalink to this headline">¶</a></h3>
<p>Suppose the name of the example above is a file <code class="docutils literal"><span class="pre">kvs.idl</span></code>, we can generate codes in the following manner.</p>
<div class="highlight-default"><div class="highlight"><pre><span></span>$ jenerator -l server -o . -n jubatus -t kvs.idl
</pre></div>
</div>
<p>See <a class="reference internal" href="../commands/jenerator.html"><span class="doc">jenerator</span></a> for the detailed usage of <code class="docutils literal"><span class="pre">jenerator</span></code>.</p>
</div>
</div>
<div class="section" id="implementing-server">
<h2>Implementing Server<a class="headerlink" href="#implementing-server" title="Permalink to this headline">¶</a></h2>
<p><code class="docutils literal"><span class="pre">kvs_impl.cpp</span></code> constructs a server instance by using class <code class="docutils literal"><span class="pre">kvs_serv</span></code>.
You need to define the class in <code class="docutils literal"><span class="pre">kvs_serv.hpp</span></code> and <code class="docutils literal"><span class="pre">kvs_serv.cpp</span></code>.
You can use templates (<code class="docutils literal"><span class="pre">kvs_serv.tmpl.{cpp,hpp}</span></code>) generated by <code class="docutils literal"><span class="pre">jenerator</span></code>.</p>
<p><code class="docutils literal"><span class="pre">main</span></code> function is implemented in <code class="docutils literal"><span class="pre">kvs_impl.cpp</span></code>, so users don&#8217;t have to implement it.
Command line options are the same among all servers using Jubatus framework.
The options can be referenced with <code class="docutils literal"><span class="pre">--help</span></code> option.</p>
<div class="section" id="mixable-class">
<h3>Mixable Class<a class="headerlink" href="#mixable-class" title="Permalink to this headline">¶</a></h3>
<p>TBD.</p>
</div>
</div>
<div class="section" id="implementing-proxy">
<h2>Implementing Proxy<a class="headerlink" href="#implementing-proxy" title="Permalink to this headline">¶</a></h2>
<p>You have nothing to implement; just compile <code class="docutils literal"><span class="pre">kvs_proxy.cpp</span></code>, generated by <code class="docutils literal"><span class="pre">jenerator</span></code>, and you will get proxy.</p>
<p><code class="docutils literal"><span class="pre">kvs_proxy.cpp</span></code> only has <code class="docutils literal"><span class="pre">main</span></code> function, that registers functor for each RPC method that proxies requests and aggregates responses.</p>
</div>
</div>


           </div>
          </div>
          <footer>
  
    <div class="rst-footer-buttons" role="navigation" aria-label="footer navigation">
      
        <a href="howtogetclients.html" class="btn btn-neutral float-right" title="How to Get Clients" accesskey="n">Next <span class="fa fa-arrow-circle-right"></span></a>
      
      
        <a href="framework.html" class="btn btn-neutral" title="Using Framework" accesskey="p"><span class="fa fa-arrow-circle-left"></span> Previous</a>
      
    </div>
  

  <hr/>

  <div role="contentinfo">
    <p>
        &copy; Copyright 2011-2018 PFN &amp; NTT.

    </p>
  </div>
  Built with <a href="http://sphinx-doc.org/">Sphinx</a> using a <a href="https://github.com/snide/sphinx_rtd_theme">theme</a> provided by <a href="https://readthedocs.org">Read the Docs</a>. 

</footer>

        </div>
      </div>

    </section>

  </div>
  


  

    <script type="text/javascript">
        var DOCUMENTATION_OPTIONS = {
            URL_ROOT:'../',
            VERSION:'1.0.8',
            COLLAPSE_INDEX:false,
            FILE_SUFFIX:'.html',
            HAS_SOURCE:  true
        };
    </script>
      <script type="text/javascript" src="../_static/jquery.js"></script>
      <script type="text/javascript" src="../_static/underscore.js"></script>
      <script type="text/javascript" src="../_static/doctools.js"></script>
      <script type="text/javascript" src="https://cdn.mathjax.org/mathjax/latest/MathJax.js?config=TeX-AMS-MML_HTMLorMML"></script>

  

  
  
    <script type="text/javascript" src="../_static/js/theme.js"></script>
  

  
  
  <script type="text/javascript">
      jQuery(function () {
          SphinxRtdTheme.StickyNav.enable();
      });
  </script>
   

</body>
</html>